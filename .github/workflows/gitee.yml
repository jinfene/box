name: APK Sync & Version Control

on:
  push:
    branches: [ main ]
    paths:
      - 'apk/release/app-release.apk'
      - 'apk/release/app-release.json'

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      LOCAL_VERSION: ${GITHUB_SHA}  # ä½¿ç”¨å®é™…æäº¤SHA
      LATEST_SHA: ${{ github.sha }}
      
    steps:
    # æ­¥éª¤1: æ£€å‡ºå½“å‰ä»“åº“
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # æ­¥éª¤2: ç‰ˆæœ¬æ£€æµ‹ï¼ˆå›¾ç‰‡ä¸­çš„æ ¸å¿ƒé€»è¾‘ï¼‰
    - name: Version Check
      run: |
        if [ "$LOCAL_VERSION" = "FIRST_RUN" ] || [ "$LOCAL_VERSION" != "$LATEST_SHA" ]; then
          echo "::warning::éœ€å˜æ›´æ–° (å½“å‰ï¼š$LOCAL_VERSION, æœ€æ–°ï¼š$LATEST_SHA)"
          echo "UPDATE_NEEDED=true" >> $GITHUB_ENV
        else
          echo "::notice::å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
          echo "UPDATE_NEEDED=false" >> $GITHUB_ENV
        fi
      shell: bash
      
    # æ­¥éª¤3: ä»…å½“éœ€è¦æ›´æ–°æ—¶åŒæ­¥åˆ°Gitee
    - name: Gitee Sync
      if: env.UPDATE_NEEDED == 'true'
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # å…‹éš†Giteeä»“åº“
        git clone -b master "https://${{ secrets.GITEE_USERNAME }}:${{ secrets.GITEE_TOKEN }}@gitee.com/${{ secrets.GITEE_REPO }}.git" gitee-repo
        
        # å¤åˆ¶APKæ–‡ä»¶
        mkdir -p gitee-repo/apk/release
        cp apk/release/app-release.apk gitee-repo/apk/release/
        cp apk/release/app-release.json gitee-repo/apk/release/
        
        # æäº¤æ›´æ–°
        cd gitee-repo
        git add .
        git commit -m "chore: åŒæ­¥æ›´æ–° (${LATEST_SHA:0:8})"
        git push origin master
      
    # æ­¥éª¤4: æ–‡ä»¶ä¸‹è½½ç¤ºä¾‹ï¼ˆæ‰©å±•åŠŸèƒ½ï¼‰
    - name: APK Download
      if: env.UPDATE_NEEDED == 'true'
      run: |
        echo "##[group]ğŸ” æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬"
        echo "æœ€æ–°SHA: $LATEST_SHA"
        echo "ä¸‹è½½é“¾æ¥:"
        echo "https://github.com/${{ github.repository }}/raw/main/apk/release/app-release.apk"
        echo "https://github.com/${{ github.repository }}/raw/main/apk/release/app-release.json"
        echo "##[endgroup]"
