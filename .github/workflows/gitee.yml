name: Sync APKs to Gitee

on:
  push:
    branches: [ main ]
    paths:
      - 'apk/release/app-release.apk'
      - 'apk/release/app-release.json'

jobs:
  sync-files:
    runs-on: ubuntu-latest
    steps:
      # 1. 检出当前GitHub仓库
      - name: Checkout GitHub repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. 配置Git信息
      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      # 3. 克隆Gitee仓库（使用master分支，根据图片）
      - name: Clone Gitee repository
        run: |
          git clone -b master https://${{ secrets.GITEE_USERNAME }}:${{ secrets.GITEE_TOKEN }}@gitee.com/${{ secrets.GITEE_REPO }}.git gitee-repo

      # 4. 复制指定文件
      - name: Copy APK files
        run: |
          mkdir -p gitee-repo/apk/release
          cp -v apk/release/app-release.apk gitee-repo/apk/release/
          cp -v apk/release/app-release.json gitee-repo/apk/release/

      # 5. 提交并推送到Gitee
      - name: Commit and push to Gitee
        run: |
          cd gitee-repo
          git add apk/release/
          if git diff-index --quiet HEAD --; then
            echo "No changes to commit"
          else
            git commit -m "chore: Sync APK files from GitHub (Commit ${{ github.sha }})"
            git push origin master
            echo "Changes pushed to Gitee"
          fi
