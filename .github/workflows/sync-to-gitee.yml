name: Sync to Gitee

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºGitHubä»“åº“
      - name: æ£€å‡ºGitHubä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. è®¾ç½®GiteeåŒæ­¥è®¤è¯
      - name: é…ç½®Giteeè®¤è¯
        run: |
          # è®¾ç½®å…¨å±€ç”¨æˆ·ä¿¡æ¯
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # æ·»åŠ Giteeè¿œç¨‹ä»“åº“
          git remote add gitee https://${{ secrets.neural-crocodile }}:${{ secrets.c6ef158406fad0a9163c59cd0fcb3b58 }}@gitee.com/${{ secrets.neural-crocodile/fm }}.git

      # 3. æ£€æŸ¥Giteeè¿æ¥
      - name: éªŒè¯Giteeè¿æ¥
        run: |
          git ls-remote --heads gitee

      # 4. åŒæ­¥åˆ°Giteeï¼ˆå¼ºåˆ¶æ¨é€ï¼‰
      - name: æ¨é€åˆ°Gitee
        run: |
          # å¤„ç†å¯èƒ½çš„å®¡æ ¸å†…å®¹
          if [ -f "content_approval.txt" ]; then
            echo "å®¡æ ¸æ ‡è®°æ–‡ä»¶å­˜åœ¨ï¼Œæ·»åŠ æäº¤ä¿¡æ¯"
            git add content_approval.txt
            git commit -m "ğŸ“ æ·»åŠ å†…å®¹å®¡æ ¸æ ‡è®°" || echo "æ— éœ€æäº¤"
          fi

          # å¼ºåˆ¶æ¨é€åˆ°Gitee
          git push gitee main:main --force

          echo "âœ… å·²åŒæ­¥åˆ°Giteeä»“åº“"

      # 5. è®¾ç½®Giteeå†…å®¹å®¡æ ¸æ ‡è®°
      - name: æ·»åŠ å®¡æ ¸æ ‡è®°
        run: |
          # åˆ›å»ºå†…å®¹å®¡æ ¸æ ‡è®°æ–‡ä»¶
          echo "æ­¤ä»“åº“å†…å®¹éœ€äººå·¥å®¡æ ¸" > content_approval.txt
          echo "åŒæ­¥æ—¶é—´: $(date)" >> content_approval.txt
          echo "åŒæ­¥æ¥æº: $GITHUB_REPOSITORY" >> content_approval.txt

          # æäº¤å®¡æ ¸æ ‡è®°
          git add content_approval.txt
          git commit -m "ğŸ“ æ·»åŠ å†…å®¹å®¡æ ¸æ ‡è®°" || echo "å·²å­˜åœ¨æ ‡è®°"

          # æ›´æ–°åˆ°Gitee
          git push gitee main:main

      # 6. é€šçŸ¥æœºåˆ¶ï¼ˆå¯é€‰ï¼‰
      - name: å‘é€å®¡æ ¸é€šçŸ¥
        if: success()
        uses: dawidd6/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
