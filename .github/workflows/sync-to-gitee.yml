name: Sync APKs to Gitee

on:
  workflow_run:
    workflows: ["APK Auto Updater"] # 您之前的APK更新工作流名称
    types: [completed]
  workflow_dispatch: # 支持手动触发

jobs:
  sync_to_gitee:
    runs-on: ubuntu-latest
    env:
      WORK_DIR: "/home/user/norebox/bbox" # 根据您的截图设置
      
    steps:
      - name: 检出GitHub仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          path: ${{ env.WORK_DIR }}
          
      - name: 配置Gitee环境
        run: |
          cd ${{ env.WORK_DIR }}
          
          # 应用Gitee推荐的全局设置（来自截图）
          git config --global user.name "神经鳄"
          git config --global user.email "972341412@qq.com"
          
          # 添加Gitee远程
          git remote add gitee https://${{ secrets.GITEE_USERNAME }}:${{ secrets.GITEE_PASSWORD }}@gitee.com/neural-crocodile/box.git
          
      - name: 推送APK文件
        run: |
          cd ${{ env.WORK_DIR }}
          
          # 仅推送必要的APK文件和版本记录
          git push gitee HEAD:main -- \
            apk/release/leanback-arm64_v8a.apk \
            apk/release/leanback-armeabi_v7a.apk \
            version.txt
          
          echo "✅ APK文件已同步到Gitee仓库"
          
      - name: 更新仓库信息
        run: |
          cd ${{ env.WORK_DIR }}
          
          # 生成同步记录文件
          echo "# 仓库同步信息" > SYNC_INFO.md
          echo "最后同步时间: $(date '+%Y-%m-%d %H:%M:%S')" >> SYNC_INFO.md
          echo "来源仓库: [$GITHUB_REPOSITORY](https://github.com/$GITHUB_REPOSITORY)" >> SYNC_INFO.md
          echo "同步文件:" >> SYNC_INFO.md
          echo "- leanback-arm64_v8a.apk" >> SYNC_INFO.md
          echo "- leanback-armeabi_v7a.apk" >> SYNC_INFO.md
          
          # 添加并提交同步记录
          git add SYNC_INFO.md
          git commit -m "📝 更新同步记录" || echo "无新同步记录"
          git push gitee HEAD:main
          
      - name: 完成通知
        run: |
          echo "✅ 同步到Gitee完成"
          echo "访问仓库: https://gitee.com/neural-crocodile/box"
