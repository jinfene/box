name: Sync APKs to Gitee - Fixed

on:
  workflow_run:
    workflows: ["APK Auto Updater"] # ç¡®ä¿ä¸æ‚¨æ›´æ–°APKçš„å·¥ä½œæµåç§°åŒ¹é…
    types: [completed]
  workflow_dispatch:

jobs:
  sync_to_gitee:
    runs-on: ubuntu-latest
    steps:
      # 1. åˆ›å»ºå·¥ä½œç›®å½•ï¼ˆæ ¹æ®æˆªå›¾ï¼‰
      - name: åˆ›å»ºå·¥ä½œç›®å½•
        run: |
          echo "æ­£åœ¨åˆ›å»ºGiteeæˆªå›¾è¦æ±‚çš„å·¥ä½œç›®å½•ç»“æ„..."
          # åˆ›å»ºä¸€çº§ç›®å½• box (Giteeæˆªå›¾ä¸­çš„ç¬¬ä¸€æ­¥)
          mkdir -p box
          cd box
          
          # åˆ›å»ºAPKå­˜å‚¨ç›®å½•ï¼ˆäºŒçº§ç›®å½•ï¼‰
          mkdir -p apk/release
          
          echo "âœ… ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ:"
          tree || ls -R
          
          # ä¿å­˜å·¥ä½œç›®å½•è·¯å¾„
          echo "WORK_DIR=$(pwd)" >> $GITHUB_ENV
          
      # 2. æ£€å‡ºGitHubä»“åº“ï¼ˆå¤åˆ¶æ‰€éœ€æ–‡ä»¶ï¼‰
      - name: å‡†å¤‡APKæ–‡ä»¶
        uses: actions/checkout@v4
        with:
          path: source-repo # æ£€å‡ºåˆ°ä¸´æ—¶ç›®å½•
          
        # å¤åˆ¶æ–‡ä»¶åˆ°å·¥ä½œç›®å½•
        run: |
          echo "ä»GitHubä»“åº“å¤åˆ¶APKæ–‡ä»¶..."
          
          # å¤åˆ¶ç‰ˆæœ¬æ–‡ä»¶
          if [ -f source-repo/version.txt ]; then
            cp source-repo/version.txt ${{ env.WORK_DIR }}/version.txt
          fi
          
          # å¤åˆ¶APKæ–‡ä»¶
          if [ -f source-repo/apk/release/leanback-arm64_v8a.apk ]; then
            cp source-repo/apk/release/leanback-arm64_v8a.apk ${{ env.WORK_DIR }}/apk/release/
          fi
          
          if [ -f source-repo/apk/release/leanback-armeabi_v7a.apk ]; then
            cp source-repo/apk/release/leanback-armeabi_v7a.apk ${{ env.WORK_DIR }}/apk/release/
          fi
          
          echo "âœ… æ–‡ä»¶å¤åˆ¶å®Œæˆ"
          ls -R ${{ env.WORK_DIR }} || tree ${{ env.WORK_DIR }}
      
      # 3. é…ç½®Gitç¯å¢ƒï¼ˆæ ¹æ®Giteeæˆªå›¾ï¼‰
      - name: é…ç½®Gitå…¨å±€è®¾ç½®
        run: |
          # ä¸¥æ ¼æŒ‰ç…§Giteeæˆªå›¾é…ç½®
          git config --global user.name "ç¥ç»é³„"
          git config --global user.email "972341412@qq.com"
          echo "âœ… Gitå…¨å±€é…ç½®å®Œæˆ"
          
      # 4. åˆå§‹åŒ–Gitä»“åº“ï¼ˆæ ¹æ®Giteeæˆªå›¾ï¼‰
      - name: åˆå§‹åŒ–Gitä»“åº“
        run: |
          cd ${{ env.WORK_DIR }}
          
          # åˆå§‹åŒ–ä»“åº“ï¼ˆGiteeæˆªå›¾ç¬¬ä¸€æ­¥ï¼‰
          git init
          
          # åˆ›å»ºåˆå§‹READMEï¼ˆGiteeè¦æ±‚ï¼‰
          echo "# TVBox APK ä»“åº“" > README.md
          echo "æ­¤ä»“åº“åŒæ­¥æ¥è‡ª GitHub çš„ APK æ–‡ä»¶" >> README.md
          echo "- åŒæ­¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> README.md
          echo "- æ¥æºä»“åº“: $GITHUB_REPOSITORY" >> README.md
          
          # æ·»åŠ åˆå§‹æ–‡ä»¶
          git add README.md
          git commit -m "ğŸ“ åˆå§‹åŒ–ä»“åº“ï¼ˆç”±GitHub Actionsåˆ›å»ºï¼‰"
          
          echo "âœ… ä»“åº“åˆå§‹åŒ–å®Œæˆ"
          git log --oneline
      
      # 5. è¿æ¥åˆ°Giteeä»“åº“ï¼ˆæ ¹æ®æˆªå›¾åˆ†æ”¯ä¸ºmasterï¼‰
      - name: è¿æ¥åˆ°Gitee
        run: |
          cd ${{ env.WORK_DIR }}
          
          # æ·»åŠ Giteeè¿œç¨‹ï¼ˆä½¿ç”¨æˆªå›¾ä¸­çš„åœ°å€ï¼‰
          git remote add origin git@gitee.com:neural-crocodile/box.git
          
          # å¼ºåˆ¶æ¨é€åˆ°masteråˆ†æ”¯ï¼ˆGiteeé»˜è®¤åˆ†æ”¯ï¼‰
          git push -u origin master --force
          
          echo "âœ… åˆå§‹åŒ–ä»“åº“å·²æ¨é€åˆ°Gitee"
      
      # 6. æ·»åŠ APKæ–‡ä»¶å¹¶åŒæ­¥
      - name: æ·»åŠ å¹¶åŒæ­¥APKæ–‡ä»¶
        run: |
          cd ${{ env.WORK_DIR }}
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
          git add .
          
          # æäº¤æ›´æ–°
          git commit -m "ğŸ“± æ·»åŠ APKæ–‡ä»¶: $(date '+%Y-%m-%d')"
          
          # æ¨é€åˆ°Gitee
          git push origin master
          
          echo "âœ… APKæ–‡ä»¶å·²æˆåŠŸåŒæ­¥åˆ°Gitee"
          
      # 7. éªŒè¯åŒæ­¥ç»“æœ
      - name: éªŒè¯åŒæ­¥
        run: |
          echo "è®¿é—®æ‚¨çš„Giteeä»“åº“æŸ¥çœ‹æ–‡ä»¶:"
          echo "https://gitee.com/neural-crocodile/box"
          echo "ä»“åº“åº”åŒ…å«ä»¥ä¸‹æ–‡ä»¶:"
          echo "- README.md"
          echo "- version.txt"
          echo "- apk/release/leanback-arm64_v8a.apk"
          echo "- apk/release/leanback-armeabi_v7a.apk"
