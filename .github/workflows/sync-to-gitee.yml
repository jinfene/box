name: Sync APKs to Gitee

on:
  workflow_run:
    workflows: ["APK Auto Updater"] # æ‚¨ä¹‹å‰çš„APKæ›´æ–°å·¥ä½œæµåç§°
    types: [completed]
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  sync_to_gitee:
    runs-on: ubuntu-latest
    env:
      WORK_DIR: "/home/user/norebox/bbox" # æ ¹æ®æ‚¨çš„æˆªå›¾è®¾ç½®
      
    steps:
      - name: æ£€å‡ºGitHubä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          path: ${{ env.WORK_DIR }}
          
      - name: é…ç½®Giteeç¯å¢ƒ
        run: |
          cd ${{ env.WORK_DIR }}
          
          # åº”ç”¨Giteeæ¨èçš„å…¨å±€è®¾ç½®ï¼ˆæ¥è‡ªæˆªå›¾ï¼‰
          git config --global user.name "ç¥ç»é³„"
          git config --global user.email "972341412@qq.com"
          
          # æ·»åŠ Giteeè¿œç¨‹
          git remote add gitee https://${{ secrets.GITEE_USERNAME }}:${{ secrets.GITEE_PASSWORD }}@gitee.com/neural-crocodile/box.git
          
      - name: æ¨é€APKæ–‡ä»¶
        run: |
          cd ${{ env.WORK_DIR }}
          
          # ä»…æ¨é€å¿…è¦çš„APKæ–‡ä»¶å’Œç‰ˆæœ¬è®°å½•
          git push gitee HEAD:main -- \
            apk/release/leanback-arm64_v8a.apk \
            apk/release/leanback-armeabi_v7a.apk \
            version.txt
          
          echo "âœ… APKæ–‡ä»¶å·²åŒæ­¥åˆ°Giteeä»“åº“"
          
      - name: æ›´æ–°ä»“åº“ä¿¡æ¯
        run: |
          cd ${{ env.WORK_DIR }}
          
          # ç”ŸæˆåŒæ­¥è®°å½•æ–‡ä»¶
          echo "# ä»“åº“åŒæ­¥ä¿¡æ¯" > SYNC_INFO.md
          echo "æœ€ååŒæ­¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" >> SYNC_INFO.md
          echo "æ¥æºä»“åº“: [$GITHUB_REPOSITORY](https://github.com/$GITHUB_REPOSITORY)" >> SYNC_INFO.md
          echo "åŒæ­¥æ–‡ä»¶:" >> SYNC_INFO.md
          echo "- leanback-arm64_v8a.apk" >> SYNC_INFO.md
          echo "- leanback-armeabi_v7a.apk" >> SYNC_INFO.md
          
          # æ·»åŠ å¹¶æäº¤åŒæ­¥è®°å½•
          git add SYNC_INFO.md
          git commit -m "ğŸ“ æ›´æ–°åŒæ­¥è®°å½•" || echo "æ— æ–°åŒæ­¥è®°å½•"
          git push gitee HEAD:main
          
      - name: å®Œæˆé€šçŸ¥
        run: |
          echo "âœ… åŒæ­¥åˆ°Giteeå®Œæˆ"
          echo "è®¿é—®ä»“åº“: https://gitee.com/neural-crocodile/box"
